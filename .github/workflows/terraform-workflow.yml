name: Terraform Workflow

on:
    workflow_dispatch:

defaults:
  run:
    working-directory: ./terraform

jobs:
  terraform-plan:
    runs-on: self-hosted
    env:
        TF_VAR_proxmox_endpoint: ${{ secrets.PROXMOX_ENDPOINT }}
        TF_VAR_proxmox_username: ${{ secrets.PROXMOX_USERNAME }}
        TF_VAR_proxmox_password: ${{ secrets.PROXMOX_PASSWORD }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

    - name: Terraform Init
      run: terraform init

    - name: Terraform Plan
      run: terraform plan

  review:
    needs: terraform-plan
    runs-on: self-hosted
    environment: 'approve'
    steps:
      - name: Review Terraform Plan
        run: |
          echo "Terraform plan accepted."

  terraform-apply:
    needs: review
    runs-on: self-hosted
    env:
        TF_VAR_proxmox_endpoint: ${{ secrets.PROXMOX_ENDPOINT }}
        TF_VAR_proxmox_username: ${{ secrets.PROXMOX_USERNAME }}
        TF_VAR_proxmox_password: ${{ secrets.PROXMOX_PASSWORD }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

    - name: Terraform Init
      run: terraform init

    - name: Terraform Apply
      run: terraform apply -auto-approve